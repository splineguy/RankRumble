{% extends "base.html" %}

{% block title %}Tournament Match - {{ project.name }} - RankRumble{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex justify-between items-center">
        <div>
            <a href="{{ url_for('tournament.bracket', project_id=project.id, tournament_id=tournament.id) }}" class="text-indigo-600 hover:text-indigo-800 text-sm">
                &larr; Back to Bracket
            </a>
            <h1 class="text-2xl font-bold text-gray-900 mt-2">{{ tournament.name }}</h1>
        </div>
        <div class="text-right">
            <div class="text-sm font-medium text-indigo-600">{{ match_info.bracket_label }}</div>
            <div class="text-sm text-gray-500">{{ match_info.round_name }} - Match {{ match_info.match_number }} of {{ match_info.total_in_round }}</div>
        </div>
    </div>
</div>

<!-- Progress Bar -->
<div class="mb-6">
    <div class="flex justify-between text-sm text-gray-500 mb-1">
        <span>Match {{ tournament.match_count + 1 }} of {{ tournament.total_matches }}</span>
        <span>{{ ((tournament.match_count / tournament.total_matches) * 100)|round|int }}% complete</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-2.5">
        <div class="bg-indigo-600 h-2.5 rounded-full transition-all" style="width: {{ (tournament.match_count / tournament.total_matches) * 100 }}%"></div>
    </div>
</div>

<!-- Battle Cards -->
<div id="battle-area" class="max-w-4xl mx-auto">
    <p class="text-center text-gray-600 mb-6">Which do you prefer?</p>

    <div class="grid md:grid-cols-[1fr_auto_1fr] gap-4 items-center">
        <!-- Item A -->
        <div id="card-a" class="bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg hover:border-indigo-300 border-2 border-transparent transition-all" onclick="submitMatch('a')">
            <div class="text-center">
                <h2 class="text-xl font-bold text-gray-900 mb-2">{{ match_info.item_a.name }}</h2>
                <div class="text-3xl font-bold text-indigo-600">{{ match_info.item_a.rating }}</div>
                <div class="text-sm text-gray-500">Current Rating</div>
                <div class="mt-4 text-sm text-gray-500">
                    {{ match_info.item_a.stats.wins }}W / {{ match_info.item_a.stats.losses }}L / {{ match_info.item_a.stats.ties }}T
                </div>
            </div>
        </div>

        <!-- VS Graphic -->
        <div class="hidden md:flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-indigo-400" viewBox="0 0 64 64" fill="none">
                <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="2" opacity="0.3"/>
                <text x="32" y="38" text-anchor="middle" font-size="20" font-weight="bold" fill="currentColor" font-family="sans-serif">VS</text>
            </svg>
        </div>

        <!-- Item B -->
        <div id="card-b" class="bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg hover:border-indigo-300 border-2 border-transparent transition-all" onclick="submitMatch('b')">
            <div class="text-center">
                <h2 class="text-xl font-bold text-gray-900 mb-2">{{ match_info.item_b.name }}</h2>
                <div class="text-3xl font-bold text-indigo-600">{{ match_info.item_b.rating }}</div>
                <div class="text-sm text-gray-500">Current Rating</div>
                <div class="mt-4 text-sm text-gray-500">
                    {{ match_info.item_b.stats.wins }}W / {{ match_info.item_b.stats.losses }}L / {{ match_info.item_b.stats.ties }}T
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Result Display -->
<div id="result" class="hidden text-center py-8 max-w-4xl mx-auto">
    <div class="flex justify-center mb-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm0 2h14v2H5v-2z"/></svg>
    </div>
    <div id="result-message" class="text-xl font-semibold mb-4"></div>
    <div id="rating-changes" class="text-gray-600 mb-6"></div>
    <div class="flex justify-center gap-3">
        <a id="next-match-btn" href="{{ url_for('tournament.play', project_id=project.id, tournament_id=tournament.id) }}"
           class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
            Next Match
        </a>
        <a href="{{ url_for('tournament.bracket', project_id=project.id, tournament_id=tournament.id) }}"
           class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
            View Bracket
        </a>
    </div>
</div>

<!-- Keyboard Shortcuts -->
<div class="mt-8 text-center text-sm text-gray-500">
    <p>Keyboard shortcuts: <kbd class="px-2 py-1 bg-gray-100 rounded">1</kbd> for left, <kbd class="px-2 py-1 bg-gray-100 rounded">2</kbd> for right, <kbd class="px-2 py-1 bg-gray-100 rounded">Enter</kbd> for next</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
const projectId = '{{ project.id }}';
const tournamentId = '{{ tournament.id }}';
const matchId = '{{ match_info.match.id }}';
const csrfToken = '{{ csrf_token() }}';
let submitted = false;

async function submitMatch(winnerSide) {
    if (submitted) return;
    submitted = true;

    // Disable cards
    document.getElementById('battle-area').classList.add('pointer-events-none', 'opacity-50');

    try {
        const response = await fetch(`/api/v1/projects/${projectId}/tournaments/${tournamentId}/match`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                match_id: matchId,
                winner_side: winnerSide
            })
        });

        const data = await response.json();

        if (data.error) {
            alert(data.error);
            submitted = false;
            document.getElementById('battle-area').classList.remove('pointer-events-none', 'opacity-50');
            return;
        }

        // Show result
        const battle = data.battle;
        let winnerName = winnerSide === 'a' ? battle.item_a_name : battle.item_b_name;
        document.getElementById('result-message').textContent = `${winnerName} wins!`;

        const changeA = battle.rating_changes.item_a;
        const changeB = battle.rating_changes.item_b;
        document.getElementById('rating-changes').textContent =
            `${battle.item_a_name}: ${battle.ratings_after.item_a} (${changeA >= 0 ? '+' : ''}${changeA}) | ${battle.item_b_name}: ${battle.ratings_after.item_b} (${changeB >= 0 ? '+' : ''}${changeB})`;

        // Check if tournament is complete
        if (data.tournament_status === 'completed') {
            document.getElementById('next-match-btn').href =
                `/projects/${projectId}/tournament/${tournamentId}/results`;
            document.getElementById('next-match-btn').textContent = 'See Champion!';
            document.getElementById('next-match-btn').classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            document.getElementById('next-match-btn').classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
        }

        document.getElementById('battle-area').classList.add('hidden');
        document.getElementById('result').classList.remove('hidden');

    } catch (error) {
        console.error('Error submitting match:', error);
        alert('Failed to submit match');
        submitted = false;
        document.getElementById('battle-area').classList.remove('pointer-events-none', 'opacity-50');
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (!submitted) {
        if (e.key === '1') submitMatch('a');
        else if (e.key === '2') submitMatch('b');
    } else {
        if (e.key === 'Enter' || e.key === ' ') {
            document.getElementById('next-match-btn').click();
        }
    }
});
</script>
{% endblock %}
