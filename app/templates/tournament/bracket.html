{% extends "base.html" %}

{% block title %}Bracket - {{ tournament.name }} - RankRumble{% endblock %}

{% block extra_css %}
<style>
    .bracket-match {
        min-width: 160px;
        font-size: 0.75rem;
    }
    .bracket-match .match-slot {
        padding: 4px 8px;
        border: 1px solid #e5e7eb;
        background: white;
    }
    .bracket-match .match-slot:first-child {
        border-bottom: none;
        border-radius: 4px 4px 0 0;
    }
    .bracket-match .match-slot:last-child {
        border-radius: 0 0 4px 4px;
    }
    .match-slot.winner {
        background: #ecfdf5;
        font-weight: 600;
        color: #065f46;
    }
    .match-slot.loser {
        color: #9ca3af;
        text-decoration: line-through;
    }
    .match-slot.empty {
        color: #d1d5db;
        font-style: italic;
    }
    .match-current {
        box-shadow: 0 0 0 2px #6366f1;
        border-radius: 4px;
    }
    .bracket-round {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        gap: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex justify-between items-center">
        <div>
            <a href="{{ url_for('projects.detail', project_id=project.id) }}" class="text-indigo-600 hover:text-indigo-800 text-sm">
                &larr; Back to {{ project.name }}
            </a>
            <h1 class="text-2xl font-bold text-gray-900 mt-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-indigo-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><line x1="10" y1="6.5" x2="14" y2="6.5"/><line x1="10" y1="17.5" x2="14" y2="17.5"/></svg>
                {{ tournament.name }}
            </h1>
        </div>
        <div class="text-right">
            <div class="text-sm text-gray-500">
                Match {{ display.match_count }} of {{ display.total_matches }}
            </div>
            <div class="w-32 bg-gray-200 rounded-full h-2 mt-1">
                <div class="bg-indigo-600 h-2 rounded-full" style="width: {{ (display.match_count / display.total_matches * 100)|round|int }}%"></div>
            </div>
        </div>
    </div>
</div>

<!-- Action Button -->
{% if tournament.status != 'completed' and next_match %}
<div class="mb-6 text-center">
    <a href="{{ url_for('tournament.play', project_id=project.id, tournament_id=tournament.id) }}"
       class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium text-lg shadow-md">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
        Play Next Match
        <span class="text-sm opacity-75">({{ next_match.bracket_label }} - {{ next_match.round_name }})</span>
    </a>
</div>
{% elif tournament.status == 'completed' %}
<div class="mb-6 text-center">
    <a href="{{ url_for('tournament.results', project_id=project.id, tournament_id=tournament.id) }}"
       class="inline-flex items-center gap-2 px-6 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-medium text-lg shadow-md">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm0 2h14v2H5v-2z"/></svg>
        View Champion
    </a>
</div>
{% endif %}

<!-- Winners Bracket -->
<div class="mb-8">
    <h2 class="text-lg font-bold text-gray-900 mb-3 flex items-center gap-2">
        <span class="w-3 h-3 bg-indigo-500 rounded-full"></span>
        Winners Bracket
    </h2>
    <div class="overflow-x-auto pb-4">
        <div class="flex gap-6 min-w-max items-stretch">
            {% for round_idx in range(display.winners_bracket|length) %}
            <div class="bracket-round" style="min-height: {{ 60 * (2 ** (3 - round_idx)) }}px;">
                <div class="text-xs font-medium text-gray-400 text-center mb-2">
                    {% if round_idx == 0 %}Round 1{% elif round_idx == 1 %}Quarterfinals{% elif round_idx == 2 %}Semifinals{% else %}WB Final{% endif %}
                </div>
                {% for match in display.winners_bracket[round_idx] %}
                <div class="bracket-match {% if next_match and next_match.match.id == match.id %}match-current{% endif %}">
                    <div class="match-slot {% if match.winner_id == match.item_a_id %}winner{% elif match.winner_id and match.winner_id != match.item_a_id %}loser{% elif not match.item_a_id %}empty{% endif %}">
                        {{ match.item_a_name or 'TBD' }}
                    </div>
                    <div class="match-slot {% if match.winner_id == match.item_b_id %}winner{% elif match.winner_id and match.winner_id != match.item_b_id %}loser{% elif not match.item_b_id %}empty{% endif %}">
                        {{ match.item_b_name or 'TBD' }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Grand Final -->
<div class="mb-8">
    <h2 class="text-lg font-bold text-gray-900 mb-3 flex items-center gap-2">
        <span class="w-3 h-3 bg-yellow-500 rounded-full"></span>
        Grand Final
    </h2>
    <div class="flex gap-6 items-start">
        <div>
            <div class="text-xs font-medium text-gray-400 text-center mb-2">Grand Final</div>
            <div class="bracket-match {% if next_match and next_match.match.id == display.grand_final.match.id %}match-current{% endif %}" style="min-width: 200px;">
                <div class="match-slot {% if display.grand_final.match.winner_id == display.grand_final.match.item_a_id %}winner{% elif display.grand_final.match.winner_id and display.grand_final.match.winner_id != display.grand_final.match.item_a_id %}loser{% elif not display.grand_final.match.item_a_id %}empty{% endif %}">
                    {{ display.grand_final.match.item_a_name or 'WB Champion' }}
                    <span class="text-gray-400 text-xs">(W)</span>
                </div>
                <div class="match-slot {% if display.grand_final.match.winner_id == display.grand_final.match.item_b_id %}winner{% elif display.grand_final.match.winner_id and display.grand_final.match.winner_id != display.grand_final.match.item_b_id %}loser{% elif not display.grand_final.match.item_b_id %}empty{% endif %}">
                    {{ display.grand_final.match.item_b_name or 'LB Champion' }}
                    <span class="text-gray-400 text-xs">(L)</span>
                </div>
            </div>
        </div>

        {% if display.grand_final.reset_match %}
        <div>
            <div class="text-xs font-medium text-red-400 text-center mb-2">True Final (Reset)</div>
            <div class="bracket-match {% if next_match and next_match.match.id == display.grand_final.reset_match.id %}match-current{% endif %}" style="min-width: 200px;">
                <div class="match-slot {% if display.grand_final.reset_match.winner_id == display.grand_final.reset_match.item_a_id %}winner{% elif display.grand_final.reset_match.winner_id and display.grand_final.reset_match.winner_id != display.grand_final.reset_match.item_a_id %}loser{% elif not display.grand_final.reset_match.item_a_id %}empty{% endif %}">
                    {{ display.grand_final.reset_match.item_a_name or 'TBD' }}
                </div>
                <div class="match-slot {% if display.grand_final.reset_match.winner_id == display.grand_final.reset_match.item_b_id %}winner{% elif display.grand_final.reset_match.winner_id and display.grand_final.reset_match.winner_id != display.grand_final.reset_match.item_b_id %}loser{% elif not display.grand_final.reset_match.item_b_id %}empty{% endif %}">
                    {{ display.grand_final.reset_match.item_b_name or 'TBD' }}
                </div>
            </div>
        </div>
        {% endif %}

        {% if display.champion_name %}
        <div class="flex items-center">
            <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-500 mx-auto mb-1" viewBox="0 0 24 24" fill="currentColor"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm0 2h14v2H5v-2z"/></svg>
                <div class="font-bold text-gray-900">{{ display.champion_name }}</div>
                <div class="text-xs text-gray-500">Champion</div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Losers Bracket -->
<div class="mb-8">
    <h2 class="text-lg font-bold text-gray-900 mb-3 flex items-center gap-2">
        <span class="w-3 h-3 bg-red-400 rounded-full"></span>
        Losers Bracket
    </h2>
    <div class="overflow-x-auto pb-4">
        <div class="flex gap-6 min-w-max items-stretch">
            {% set lb_labels = ['LB Round 1', 'LB Round 2', 'LB Round 3', 'LB Round 4', 'LB Semifinal', 'LB Final'] %}
            {% for round_idx in range(display.losers_bracket|length) %}
            <div class="bracket-round">
                <div class="text-xs font-medium text-gray-400 text-center mb-2">
                    {{ lb_labels[round_idx] }}
                </div>
                {% for match in display.losers_bracket[round_idx] %}
                <div class="bracket-match {% if next_match and next_match.match.id == match.id %}match-current{% endif %}">
                    <div class="match-slot {% if match.winner_id == match.item_a_id %}winner{% elif match.winner_id and match.winner_id != match.item_a_id %}loser{% elif not match.item_a_id %}empty{% endif %}">
                        {{ match.item_a_name or 'TBD' }}
                    </div>
                    <div class="match-slot {% if match.winner_id == match.item_b_id %}winner{% elif match.winner_id and match.winner_id != match.item_b_id %}loser{% elif not match.item_b_id %}empty{% endif %}">
                        {{ match.item_b_name or 'TBD' }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Seeding Reference -->
<details class="bg-white rounded-lg shadow-md p-4">
    <summary class="cursor-pointer text-sm font-medium text-gray-700">View Seeding</summary>
    <div class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm">
        {% for item_id in tournament.seeding %}
        {% set item = project['items'][item_id] %}
        <div class="flex items-center gap-2 py-1">
            <span class="text-gray-400 font-mono text-xs w-5">#{{ loop.index }}</span>
            <span class="text-gray-900">{{ item.name }}</span>
            <span class="text-gray-400 text-xs">({{ item.rating }})</span>
        </div>
        {% endfor %}
    </div>
</details>
{% endblock %}
