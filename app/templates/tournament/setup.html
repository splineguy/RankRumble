{% extends "base.html" %}

{% block title %}Sweet Sixteen - {{ project.name }} - RankRumble{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{{ url_for('projects.detail', project_id=project.id) }}" class="text-indigo-600 hover:text-indigo-800 text-sm">
        &larr; Back to {{ project.name }}
    </a>
    <h1 class="text-2xl font-bold text-gray-900 mt-2 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-indigo-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><line x1="10" y1="6.5" x2="14" y2="6.5"/><line x1="10" y1="17.5" x2="14" y2="17.5"/></svg>
        Sweet Sixteen Tournament
    </h1>
    <p class="text-gray-600 mt-1">Select exactly 16 items for a double-elimination bracket tournament.</p>
</div>

<form method="POST" action="{{ url_for('tournament.create', project_id=project.id) }}" id="tournament-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- Tournament Name -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Tournament Name (optional)</label>
        <input type="text" name="name" id="name" placeholder="e.g., March Madness Rankings"
               class="w-full max-w-md px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
    </div>

    <!-- Selection Controls -->
    <div class="flex flex-wrap items-center gap-3 mb-4">
        <span class="text-sm font-medium text-gray-700">
            Selected: <span id="selected-count" class="text-indigo-600 font-bold">0</span> / 16
        </span>
        <button type="button" onclick="selectRandom16()" class="px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 text-sm font-medium">
            Random 16
        </button>
        <button type="button" onclick="selectTop16()" class="px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 text-sm font-medium">
            Top 16 by Rating
        </button>
        <button type="button" onclick="clearSelection()" class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm font-medium">
            Clear All
        </button>
    </div>

    <!-- Items Grid -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-0 divide-y sm:divide-y-0 sm:divide-x divide-gray-100">
            {% for item in items %}
            <label class="flex items-center p-3 hover:bg-indigo-50 cursor-pointer transition-colors item-label" data-item-id="{{ item.id }}">
                <input type="checkbox" name="item_ids" value="{{ item.id }}"
                       class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded item-checkbox"
                       onchange="updateCount()">
                <div class="ml-3 min-w-0">
                    <div class="text-sm font-medium text-gray-900 truncate">{{ item.name }}</div>
                    <div class="text-xs text-gray-500">{{ item.rating }} ELO</div>
                </div>
            </label>
            {% endfor %}
        </div>
    </div>

    <!-- Submit -->
    <div class="flex justify-end gap-3">
        <a href="{{ url_for('projects.detail', project_id=project.id) }}" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
            Cancel
        </a>
        <button type="submit" id="start-btn" disabled
                class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
            Start Tournament
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
const allCheckboxes = document.querySelectorAll('.item-checkbox');
const countEl = document.getElementById('selected-count');
const startBtn = document.getElementById('start-btn');

function updateCount() {
    const checked = document.querySelectorAll('.item-checkbox:checked').length;
    countEl.textContent = checked;
    startBtn.disabled = checked !== 16;

    if (checked === 16) {
        countEl.classList.add('text-green-600');
        countEl.classList.remove('text-indigo-600', 'text-red-600');
    } else if (checked > 16) {
        countEl.classList.add('text-red-600');
        countEl.classList.remove('text-indigo-600', 'text-green-600');
    } else {
        countEl.classList.add('text-indigo-600');
        countEl.classList.remove('text-green-600', 'text-red-600');
    }
}

function selectRandom16() {
    clearSelection();
    const indices = Array.from({length: allCheckboxes.length}, (_, i) => i);
    // Shuffle
    for (let i = indices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
    }
    indices.slice(0, 16).forEach(i => allCheckboxes[i].checked = true);
    updateCount();
}

function selectTop16() {
    clearSelection();
    // Items are already sorted by rating descending from the server
    for (let i = 0; i < Math.min(16, allCheckboxes.length); i++) {
        allCheckboxes[i].checked = true;
    }
    updateCount();
}

function clearSelection() {
    allCheckboxes.forEach(cb => cb.checked = false);
    updateCount();
}
</script>
{% endblock %}
